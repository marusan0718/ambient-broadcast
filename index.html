<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambient Music</title>

  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.3.5/Tone.js"></script>

  <style>
    summary::-webkit-details-marker { display:none; }
    /* iOSのfixed + overflow対策：パネル内スクロールを“掴める”ように */
    .ios-scroll { -webkit-overflow-scrolling: touch; }
  </style>
</head>

<body class="min-h-screen text-slate-900">
  <main class="min-h-screen flex items-center justify-center p-5 sm:p-8">
    <div class="w-full max-w-xl">
      <!-- Card -->
      <div class="rounded-[28px] border border-white/70 bg-white/70 backdrop-blur-xl shadow-[0_20px_60px_rgba(15,23,42,0.10)] overflow-hidden">
        <!-- Header -->
        <div class="px-6 sm:px-8 pt-7 pb-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="inline-flex items-center gap-2 rounded-full bg-white/80 border border-slate-200 px-3 py-1 text-xs text-slate-600">
                <span id="dot" class="inline-block size-2 rounded-full bg-slate-400"></span>
                <span id="modeText">Ready</span>
              </div>
              <h1 class="mt-3 text-2xl font-semibold tracking-tight">Ambient Music</h1>
              <p class="mt-1 text-sm text-slate-600">
                季節、天気、風のゆらぎ。<br class="hidden sm:block">
                いまこの瞬間の自然と同期し、音楽を紡ぐ。
              </p>
            </div>

            <div class="text-right">
              <div class="text-xs text-slate-500">自動更新</div>
              <div id="countdown" class="mt-1 text-sm font-medium text-slate-700 tabular-nums">—</div>
            </div>
          </div>

          <!-- Big button -->
          <button id="btnToggle"
            class="mt-5 w-full rounded-3xl px-5 py-6 sm:py-7 transition active:scale-[0.99]
                   bg-slate-900 text-white hover:bg-slate-800
                   shadow-[0_18px_40px_rgba(15,23,42,0.22)]">
            <div class="flex items-center justify-center gap-4">
              <div class="grid place-items-center size-12 rounded-2xl bg-white/10 border border-white/15">
                <svg id="iconSvg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="opacity-95">
                  <path d="M8 5v14l11-7z"></path>
                </svg>
              </div>
              <div class="text-left">
                <div id="btnLabel" class="text-xl font-semibold">Start</div>
                <div id="btnSub" class="text-xs text-white/75">タップで再生（AirPlayはコントロールセンターから）</div>
              </div>
            </div>
          </button>

          <!-- Status line (simple) -->
          <div class="mt-4 text-sm text-slate-700">
            <span class="text-slate-500">状態：</span><span id="status">待機中（Startで音が鳴る）</span>
          </div>

          <!-- Minimal metrics -->
          <div class="mt-3 grid grid-cols-2 gap-3">
            <div class="rounded-2xl bg-white/75 border border-slate-200 p-4">
              <div class="text-xs text-slate-500">天気</div>
              <div id="weatherText" class="mt-1 text-base font-medium">—</div>
              <div class="mt-2 text-[11px] text-slate-500">コード: <span id="weatherCode">—</span></div>
            </div>
            <div class="rounded-2xl bg-white/75 border border-slate-200 p-4">
              <div class="text-xs text-slate-500">風速</div>
              <div class="mt-1 text-base font-medium"><span id="windSpeed">—</span> m/s</div>
              <div class="mt-2 text-[11px] text-slate-500">密度: <span id="density">—</span></div>
            </div>
          </div>
        </div>

        <!-- Footer actions -->
        <div class="border-t border-white/70 bg-white/55">
          <div class="px-6 sm:px-8 py-4 flex items-center justify-between gap-3">
            <button id="btnRefresh"
              class="px-4 py-2 rounded-2xl text-sm bg-white/80 border border-slate-200 hover:bg-white active:scale-[0.99]">
              更新
            </button>

            <!-- Settings trigger (we keep details for semantics, but panel is fixed) -->
            <details id="settingsDetails" class="group">
              <summary
                class="list-none cursor-pointer select-none px-4 py-2 rounded-2xl text-sm
                       bg-white/80 border border-slate-200 hover:bg-white active:scale-[0.99]
                       inline-flex items-center gap-2">
                設定
                <span class="text-slate-400 group-open:rotate-180 transition">▾</span>
              </summary>
            </details>
          </div>
        </div>
      </div>

      <div class="mt-4 text-center text-xs text-slate-500">
        AirPlay：iPhoneのコントロールセンターからHomePodへ
      </div>
    </div>
  </main>

  <!-- Settings Overlay (fixed, always within viewport) -->
  <div id="settingsOverlay" class="fixed inset-0 z-50 hidden">
    <!-- backdrop -->
    <div id="settingsBackdrop" class="absolute inset-0 bg-slate-900/10 backdrop-blur-[2px]"></div>

    <!-- panel wrapper (align to bottom on mobile, center-ish on desktop) -->
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6">
      <div
        class="w-full max-w-[520px]
               rounded-[28px] bg-white/95 border border-slate-200 shadow-2xl
               overflow-hidden">
        <!-- header -->
        <div class="px-5 sm:px-6 py-4 border-b border-slate-200 flex items-center justify-between">
          <div class="text-sm font-semibold text-slate-800">設定</div>
          <button id="btnCloseSettings"
            class="px-3 py-1.5 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800 active:scale-[0.99]">
            閉じる
          </button>
        </div>

        <!-- scroll area -->
        <div class="px-5 sm:px-6 py-4 max-h-[70vh] overflow-y-auto ios-scroll">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div>
              <div class="text-xs text-slate-500 mb-1">季節</div>
              <select id="seasonSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                <option value="auto">Auto</option>
                <option value="spring">春</option>
                <option value="summer">夏</option>
                <option value="autumn">秋</option>
                <option value="winter">冬</option>
              </select>
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-1">時間</div>
              <select id="timeSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                <option value="auto">Auto</option>
                <option value="morning">朝</option>
                <option value="day">昼</option>
                <option value="evening">夕</option>
                <option value="night">夜</option>
                <option value="late">深夜</option>
              </select>
            </div>
            <div>
              <div class="text-xs text-slate-500 mb-1">天気</div>
              <select id="weatherSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                <option value="auto">Auto</option>
                <option value="clear">晴れ</option>
                <option value="rain">雨</option>
                <option value="other">その他</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-xs text-slate-500 mb-2">位置情報が使えない場合（手入力）</div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <input id="lat" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="lat (例: 35.681)" />
              <input id="lon" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm" placeholder="lon (例: 139.767)" />
              <button id="btnUseManual" class="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:bg-slate-800 active:scale-[0.99]">
                この座標で取得
              </button>
            </div>
          </div>

          <div class="mt-4 flex items-center justify-between gap-3">
            <button id="btnRefreshInSettings"
              class="px-3 py-2 rounded-xl text-sm bg-white border border-slate-200 hover:bg-white active:scale-[0.99]">
              いま更新
            </button>
            <div class="text-[11px] text-slate-500">
              ロック画面表示：再生開始後にOS側へ情報を渡します（完全保証ではないよ）
            </div>
          </div>
        </div>

        <!-- footer -->
        <div class="px-5 sm:px-6 py-3 border-t border-slate-200 text-[11px] text-slate-500">
          ヒント：外側をタップ / Esc で閉じる
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // Weather
  // =========================
  const OPEN_METEO_URL = "https://api.open-meteo.com/v1/forecast";
  const AUTO_UPDATE_MS = 5 * 60 * 1000;
  let nextUpdateAt = Date.now() + AUTO_UPDATE_MS;

  function describeWeather(code) {
    if (code === 0) return "快晴";
    if ([1,2].includes(code)) return "晴れ/薄曇り";
    if (code === 3) return "くもり";
    if ([45,48].includes(code)) return "霧";
    if ([51,53,55,56,57].includes(code)) return "霧雨";
    if ([61,63,65,66,67].includes(code)) return "雨";
    if ([71,73,75,77].includes(code)) return "雪";
    if ([80,81,82].includes(code)) return "にわか雨";
    if ([95,96,99].includes(code)) return "雷雨";
    return "不明";
  }

  function weatherCategoryFromCode(code) {
    if (code === 0 || [1,2].includes(code)) return "clear";
    if ([61,63,65,66,67,80,81,82,51,53,55,56,57,95,96,99].includes(code)) return "rain";
    return "other";
  }

  async function fetchWeatherByCoords(lat, lon) {
    const url = new URL(OPEN_METEO_URL);
    url.searchParams.set("latitude", lat);
    url.searchParams.set("longitude", lon);
    url.searchParams.set("current", "weather_code,wind_speed_10m");
    url.searchParams.set("timezone", "auto");
    const res = await fetch(url.toString());
    if (!res.ok) throw new Error("天気取得に失敗しました");
    const data = await res.json();
    const code = data?.current?.weather_code;
    const wind = data?.current?.wind_speed_10m;
    if (typeof code !== "number" || typeof wind !== "number") throw new Error("天気データ形式が想定と違います");
    return { code, wind };
  }

  function getCurrentPosition() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("このブラウザは位置情報に対応していません"));
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: false,
        timeout: 8000,
        maximumAge: 60_000,
      });
    });
  }

  // =========================
  // Env helpers
  // =========================
  function autoTimeBlock(){
    const h = new Date().getHours();
    if (h >= 5 && h < 10) return "morning";
    if (h >= 10 && h < 16) return "day";
    if (h >= 16 && h < 19) return "evening";
    if (h >= 19 && h < 24) return "night";
    return "late";
  }

  function autoSeason(){
    const m = new Date().getMonth() + 1;
    if (m >= 3 && m <= 5) return "spring";
    if (m >= 6 && m <= 8) return "summer";
    if (m >= 9 && m <= 11) return "autumn";
    return "winter";
  }

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
  function setStatus(msg) { document.getElementById("status").textContent = msg; }

  // 白トーン背景（時間帯）
  function applyWhiteByTime(time){
    const map = {
      morning: ["from-sky-50",   "via-white", "to-slate-100"],
      day:     ["from-white",    "via-white", "to-slate-100"],
      evening: ["from-amber-50", "via-white", "to-rose-100"],
      night:   ["from-slate-50", "via-white", "to-slate-200"],
      late:    ["from-slate-50", "via-white", "to-slate-200"],
    };
    const [a,b,c] = map[time] || map.day;
    document.body.className = `min-h-screen text-slate-900 bg-gradient-to-b ${a} ${b} ${c}`;
  }

  function windToIntervalSeconds(wind){
    const w = clamp(wind, 0, 15);
    const t = 1.2 - (w/15)*1.02;
    return clamp(t, 0.18, 1.2);
  }

  function getEnv(lastWeather){
    const seasonSel = document.getElementById("seasonSel").value;
    const timeSel   = document.getElementById("timeSel").value;
    const weatherSel= document.getElementById("weatherSel").value;

    const season = (seasonSel === "auto") ? autoSeason() : seasonSel;
    const time   = (timeSel === "auto") ? autoTimeBlock() : timeSel;
    const weatherCat = (weatherSel === "auto") ? weatherCategoryFromCode(lastWeather.code) : weatherSel;

    return { season, time, weatherCat };
  }

  // =========================
  // Media Session（ロック画面表示寄せ）
  // =========================
  function setMediaSessionMetadata(text){
    if (!("mediaSession" in navigator)) return;
    try{
      navigator.mediaSession.metadata = new MediaMetadata({
        title: "Ambient Music",
        artist: text,
        album: "Nature Sync"
      });

      navigator.mediaSession.setActionHandler("play",  async () => { if (!isRunning) await start(); });
      navigator.mediaSession.setActionHandler("pause", () => { if (isRunning) stop(); });
    } catch(e){}
  }

  function updatePlaybackState(){
    if (!("mediaSession" in navigator)) return;
    try{
      navigator.mediaSession.playbackState = isRunning ? "playing" : "paused";
    } catch(e){}
  }

  // =========================
  // Music（そのまま）
  // =========================
  let isRunning = false;
  let reverb, filter;

  let sparkle, sparkleDelay, sparklePanner;
  let bird, birdFilter, birdTremolo;

  let sparkleLoop, birdLoop;
  let chordEventId = null;

  let lastWeather = { code: 0, wind: 0 };
  let lastRoot = null;

  const HARM_PLAY_MIN = 26.0;
  const HARM_PLAY_MAX = 52.0;
  const GAP_MIN = 3.0;
  const GAP_MAX = 8.0;

  function ensureAudioGraph(){
    if (sparkle) return;

    reverb = new Tone.Reverb({ decay: 10.5, wet: 0.30 }).toDestination();
    filter = new Tone.Filter({ type: "lowpass", frequency: 1800, rolloff: -12 }).connect(reverb);

    sparkleDelay = new Tone.FeedbackDelay({ delayTime: "32n", feedback: 0.22, wet: 0.20 });
    sparklePanner = new Tone.Panner(0).connect(filter);
    sparkleDelay.connect(sparklePanner);

    sparkle = new Tone.Synth({
      oscillator: { type: "sine" },
      envelope: { attack: 0.01, decay: 0.12, sustain: 0.0, release: 1.2 }
    }).connect(sparkleDelay);
    sparkle.volume.value = -12;

    birdTremolo = new Tone.Tremolo({ frequency: 9, depth: 0.6, wet: 1.0 }).start();
    birdFilter = new Tone.Filter({ type: "bandpass", frequency: 2200, Q: 6 });
    bird = new Tone.Synth({
      oscillator: { type: "sine" },
      envelope: { attack: 0.005, decay: 0.08, sustain: 0.0, release: 0.16 }
    });
    bird.chain(birdTremolo, birdFilter, reverb);
    bird.volume.value = -20;
  }

  function keyFromSeason(season){
    if (season === "spring") return "C";
    if (season === "summer") return "D";
    if (season === "autumn") return "Eb";
    if (season === "winter") return "A";
    return "C";
  }

  function chordChoicesForKey(key){
    const map = {
      "C":  ["C4","D4","E4","F4","G4","A4"],
      "D":  ["D4","E4","F#4","G4","A4","B4"],
      "Eb": ["Eb4","F4","G4","Ab4","Bb4","C5"],
      "A":  ["A3","B3","C#4","D4","E4","F#4"]
    };
    return map[key] || map["C"];
  }

  function triad(rootNote){
    const r = Tone.Frequency(rootNote);
    return [ r.toNote(), r.transpose(4).toNote(), r.transpose(7).toNote() ];
  }

  function sparkleScale(key, weatherCat, time){
    const major = {
      "C":  ["C5","D5","E5","F5","G5","A5","B5","C6"],
      "D":  ["D5","E5","F#5","G5","A5","B5","C#6","D6"],
      "Eb": ["Eb5","F5","G5","Ab5","Bb5","C6","D6","Eb6"],
      "A":  ["A4","B4","C#5","D5","E5","F#5","G#5","A5"],
    };
    const pent = {
      "C":  ["C5","D5","E5","G5","A5","C6"],
      "D":  ["D5","E5","F#5","A5","B5","D6"],
      "Eb": ["Eb5","F5","G5","Bb5","C6","Eb6"],
      "A":  ["A4","B4","C#5","E5","F#5","A5"],
    };
    const usePent = (weatherCat === "rain") || (time === "night" || time === "late");
    return usePent ? (pent[key] || pent["C"]) : (major[key] || major["C"]);
  }

  function randomBetween(min, max){ return min + Math.random() * (max - min); }

  function applyParams(){
    const env = getEnv(lastWeather);
    const key = keyFromSeason(env.season);

    applyWhiteByTime(env.time);

    let bpm = 66;
    if (env.time === "morning") bpm = 74;
    if (env.time === "day") bpm = 78;
    if (env.time === "evening") bpm = 70;
    if (env.time === "night") bpm = 60;
    if (env.time === "late") bpm = 54;
    Tone.Transport.bpm.value = bpm;

    let cutoff = 1800, wet = 0.30;
    if (env.weatherCat === "clear") { cutoff = 2600; wet = 0.20; }
    if (env.weatherCat === "other") { cutoff = 1800; wet = 0.32; }
    if (env.weatherCat === "rain")  { cutoff = 1300; wet = 0.44; }

    filter.frequency.value = clamp(cutoff, 900, 3200);
    reverb.wet.value = clamp(wet, 0.18, 0.60);

    if (birdFilter){
      birdFilter.frequency.value = (env.weatherCat === "rain") ? 1900 : 2300;
    }

    const windText = `${lastWeather.wind.toFixed(1)} m/s`;
    setMediaSessionMetadata(`${env.season} / ${env.weatherCat} / wind ${windText}`);

    setStatus(`再生中：${env.season}/${env.time}/${env.weatherCat}（Key:${key}）`);
    return { ...env, key };
  }

  function clearHarmonyScheduler(){
    if (chordEventId !== null){
      try { Tone.Transport.clear(chordEventId); } catch(e){}
      chordEventId = null;
    }
  }

  function playOneHarmony(startTime, r){
    const choices = chordChoicesForKey(r.key);

    let root = choices[Math.floor(Math.random() * choices.length)];
    if (root === lastRoot) root = choices[Math.floor(Math.random() * choices.length)];
    lastRoot = root;

    const playDur = randomBetween(HARM_PLAY_MIN, HARM_PLAY_MAX);
    const gapDur  = randomBetween(GAP_MIN, GAP_MAX);

    const chordGain = new Tone.Gain(0.000001).connect(filter);
    const chordPad = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "sine" },
      envelope: { attack: 2.2, decay: 0.6, sustain: 0.82, release: 18.0 }
    }).connect(chordGain);
    chordPad.volume.value = -15;

    let peak = 0.22 + Math.random() * 0.30;
    if (r.time === "night" || r.time === "late") peak *= 0.75;
    if (r.weatherCat === "rain") peak *= 0.85;

    const upPortion = 0.35 + Math.random() * 0.35;
    const t0 = startTime;
    const tPeak = startTime + playDur * upPortion;
    const tEnd = startTime + playDur;

    chordGain.gain.setValueAtTime(0.00012, t0);
    chordGain.gain.exponentialRampToValueAtTime(Math.max(0.00025, peak), tPeak);
    chordGain.gain.exponentialRampToValueAtTime(0.00012, tEnd);

    chordPad.triggerAttackRelease(triad(root), playDur, startTime, 0.72);

    const disposeAt = tEnd + 22.0;
    Tone.Transport.scheduleOnce(() => { chordPad.dispose(); chordGain.dispose(); }, disposeAt);

    const nextTime = startTime + playDur + gapDur;
    chordEventId = Tone.Transport.scheduleOnce((t) => {
      const rr = applyParams();
      playOneHarmony(t, rr);
    }, nextTime);
  }

  function pickFineDelayTimeSeconds(r){
    const night = (r.time === "night" || r.time === "late");
    const rain  = (r.weatherCat === "rain");
    const shortSet = ["64n","32n","16t","24n"];
    const midSet   = ["32n","24n","16n","16t"];
    const set = (night || rain) ? midSet : shortSet;
    const base = set[Math.floor(Math.random() * set.length)];
    const baseSec = Tone.Time(base).toSeconds();
    const jitter = (Math.random() * 0.05) - 0.025;
    return clamp(baseSec + jitter, 0.02, 0.25);
  }

  function rebuildLoops(){
    if (sparkleLoop) { sparkleLoop.dispose(); sparkleLoop = null; }
    if (birdLoop) { birdLoop.dispose(); birdLoop = null; }
    clearHarmonyScheduler();

    const r = applyParams();
    const startAt = Tone.Transport.seconds + 0.1;
    chordEventId = Tone.Transport.scheduleOnce((t) => playOneHarmony(t, r), startAt);

    const sparkleInterval = 0.58;
    sparkleLoop = new Tone.Loop((time) => {
      const scale = sparkleScale(r.key, r.weatherCat, r.time);

      let p = 0.58;
      if (r.weatherCat === "rain") p = 0.44;
      if (r.time === "late") p = 0.30;
      if (r.time === "night") p = Math.min(p, 0.40);
      if (r.weatherCat === "clear" && (r.time === "day" || r.time === "morning")) p = 0.64;

      if (Math.random() < p){
        sparkleDelay.delayTime.setValueAtTime(pickFineDelayTimeSeconds(r), time);

        const pan = (Math.random() * 1.6) - 0.8;
        sparklePanner.pan.cancelScheduledValues(time);
        sparklePanner.pan.setValueAtTime(sparklePanner.pan.value, time);
        sparklePanner.pan.linearRampToValueAtTime(pan, time + 0.06);

        const note = scale[Math.floor(Math.random() * scale.length)];
        if (Math.random() < 0.12){
          const note2 = scale[Math.floor(Math.random() * scale.length)];
          sparkle.triggerAttackRelease(note, 0.12, time, 0.44);
          sparkle.triggerAttackRelease(note2, 0.12, time + 0.02, 0.34);
        } else {
          sparkle.triggerAttackRelease(note, 0.12, time, 0.44);
        }
      }
    }, sparkleInterval).start(0);

    function birdChance(){
      let base = 0.05;
      if (r.time === "morning") base = 0.12;
      if (r.time === "day") base = 0.10;
      if (r.time === "evening") base = 0.06;
      if (r.time === "night") base = 0.02;
      if (r.time === "late") base = 0.006;
      if (r.weatherCat === "rain") base *= 0.55;
      return base;
    }

    function chirp(time){
      const base = 1450 + Math.random()*650;
      const up = base + 900 + Math.random()*450;
      const dur = 0.055 + Math.random()*0.06;

      bird.frequency.setValueAtTime(base, time);
      bird.frequency.linearRampToValueAtTime(up, time + dur);
      bird.frequency.linearRampToValueAtTime(base + 220, time + dur + 0.03);
      bird.triggerAttackRelease("C6", dur + 0.06, time, 0.30);
    }

    birdLoop = new Tone.Loop((time) => {
      if (!bird) return;
      if (Math.random() < birdChance()){
        const n = (Math.random() < 0.38) ? 2 : 1;
        for (let i=0; i<n; i++){
          chirp(time + i*(0.12 + Math.random()*0.10));
        }
      }
    }, 2.4).start(0);
  }

  function updateUI({ code, wind }){
    document.getElementById("weatherText").textContent = describeWeather(code);
    document.getElementById("weatherCode").textContent = String(code);
    document.getElementById("windSpeed").textContent = wind.toFixed(1);
    document.getElementById("density").textContent = (1 / windToIntervalSeconds(wind)).toFixed(1) + " notes/sec";
  }

  function setButtonState(){
    const dot = document.getElementById("dot");
    const modeText = document.getElementById("modeText");
    const btn = document.getElementById("btnToggle");
    const label = document.getElementById("btnLabel");
    const sub = document.getElementById("btnSub");
    const iconSvg = document.getElementById("iconSvg");

    if (isRunning){
      dot.className = "inline-block size-2 rounded-full bg-emerald-500";
      modeText.textContent = "Playing";
      btn.classList.remove("bg-slate-900","hover:bg-slate-800");
      btn.classList.add("bg-rose-600","hover:bg-rose-500");
      label.textContent = "Stop";
      sub.textContent = "タップで停止";
      iconSvg.innerHTML = '<path d="M6 6h5v12H6zM13 6h5v12h-5z"></path>';
    } else {
      dot.className = "inline-block size-2 rounded-full bg-slate-400";
      modeText.textContent = "Ready";
      btn.classList.remove("bg-rose-600","hover:bg-rose-500");
      btn.classList.add("bg-slate-900","hover:bg-slate-800");
      label.textContent = "Start";
      sub.textContent = "タップで再生（AirPlayはコントロールセンターから）";
      iconSvg.innerHTML = '<path d="M8 5v14l11-7z"></path>';
    }
    updatePlaybackState();
  }

  async function start(){
    ensureAudioGraph();
    await Tone.start();
    Tone.Transport.start();
    rebuildLoops();
    isRunning = true;
    setButtonState();
  }

  function stop(){
    isRunning = false;
    clearHarmonyScheduler();
    if (sparkleLoop) { sparkleLoop.stop(); sparkleLoop.dispose(); sparkleLoop = null; }
    if (birdLoop) { birdLoop.stop(); birdLoop.dispose(); birdLoop = null; }
    Tone.Transport.stop();
    setStatus("停止中（Startで再開）");
    setButtonState();
  }

  async function refreshWeather(auto=true){
    try{
      setStatus("天気取得中…");
      let lat, lon;

      if (auto){
        const pos = await getCurrentPosition();
        lat = pos.coords.latitude;
        lon = pos.coords.longitude;
      } else {
        lat = parseFloat(document.getElementById("lat").value);
        lon = parseFloat(document.getElementById("lon").value);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error("lat/lon を数値で入力してね");
      }

      const { code, wind } = await fetchWeatherByCoords(lat, lon);
      lastWeather = { code, wind };
      updateUI(lastWeather);

      nextUpdateAt = Date.now() + AUTO_UPDATE_MS;

      applyParams();
      if (isRunning){
        rebuildLoops();
        setStatus("再生中（更新反映）");
      } else {
        setStatus("取得OK（Startで音が鳴る）");
      }
    } catch(e){
      console.error(e);
      setStatus(`エラー: ${e.message}`);
    }
  }

  function tick(){
    const remain = Math.max(0, nextUpdateAt - Date.now());
    const mm = String(Math.floor(remain/60000)).padStart(2,"0");
    const ss = String(Math.floor((remain%60000)/1000)).padStart(2,"0");
    document.getElementById("countdown").textContent = `${mm}:${ss}`;
    if (remain === 0) refreshWeather(true);
    requestAnimationFrame(tick);
  }

  // =========================
  // Settings overlay control (new)
  // =========================
  const settingsDetails = document.getElementById("settingsDetails");
  const settingsOverlay = document.getElementById("settingsOverlay");
  const settingsBackdrop = document.getElementById("settingsBackdrop");
  const btnCloseSettings = document.getElementById("btnCloseSettings");
  const btnRefreshInSettings = document.getElementById("btnRefreshInSettings");

  function openSettings(){
    settingsOverlay.classList.remove("hidden");
    // detailsは見た目用なのでopen状態は戻しておく（Safari癖対策）
    settingsDetails.open = false;
    document.documentElement.classList.add("overflow-hidden");
    document.body.classList.add("overflow-hidden");
  }

  function closeSettings(){
    settingsOverlay.classList.add("hidden");
    document.documentElement.classList.remove("overflow-hidden");
    document.body.classList.remove("overflow-hidden");
  }

  // summaryクリックでオーバーレイを開く
  settingsDetails.addEventListener("toggle", () => {
    if (settingsDetails.open) openSettings();
  });

  btnCloseSettings.addEventListener("click", closeSettings);
  settingsBackdrop.addEventListener("click", closeSettings);
  btnRefreshInSettings.addEventListener("click", () => refreshWeather(true));

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSettings();
  });

  // UI events
  document.getElementById("btnToggle").addEventListener("click", async () => {
    if (!isRunning) await start();
    else stop();
  });
  document.getElementById("btnRefresh").addEventListener("click", () => refreshWeather(true));
  document.getElementById("btnUseManual").addEventListener("click", () => refreshWeather(false));

  ["seasonSel","timeSel","weatherSel"].forEach(id => {
    document.getElementById(id).addEventListener("change", () => {
      applyParams();
      if (isRunning) rebuildLoops();
    });
  });

  // init
  setButtonState();
  applyWhiteByTime(autoTimeBlock());
  refreshWeather(true);
  tick();
</script>
</body>
</html>
