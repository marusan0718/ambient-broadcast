<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambient Music</title>

  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.3.5/Tone.js"></script>

  <style>
    summary::-webkit-details-marker { display:none; }
    .ios-scroll { -webkit-overflow-scrolling: touch; }
    .glass {
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
  </style>
</head>

<body class="min-h-screen text-slate-900">
  <main class="min-h-screen flex items-center justify-center p-5 sm:p-8">
    <div class="w-full max-w-xl">
      <div class="rounded-[28px] border border-white/70 glass shadow-[0_20px_60px_rgba(15,23,42,0.10)] overflow-hidden">
        <div class="px-6 sm:px-8 pt-7 pb-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="inline-flex items-center gap-2 rounded-full bg-white/80 border border-slate-200 px-3 py-1 text-xs text-slate-600">
                <span id="dot" class="inline-block size-2 rounded-full bg-slate-400"></span>
                <span id="modeText">Ready</span>
              </div>

              <h1 class="mt-3 text-2xl font-semibold tracking-tight">Ambient Music</h1>

              <p class="mt-1 text-sm text-slate-600">å­£ç¯€ã€å¤©æ°—ã€é¢¨ã®ã‚†ã‚‰ãã€‚</p>
              <p class="mt-1 text-sm text-slate-600">ã„ã¾ã“ã®ç¬é–“ã®è‡ªç„¶ã¨åŒæœŸã—ã€éŸ³æ¥½ã‚’ç´¡ãã€‚</p>
            </div>

            <div class="text-right">
              <div class="text-[10px] sm:text-xs text-slate-500 whitespace-nowrap">è‡ªå‹•æ›´æ–°</div>
              <div id="countdown" class="mt-1 text-sm font-medium text-slate-700 tabular-nums">â€”</div>
            </div>
          </div>

          <button id="btnToggle"
            class="mt-5 w-full rounded-3xl px-5 py-6 sm:py-7 transition active:scale-[0.99]
                   bg-slate-900 text-white hover:bg-slate-800
                   shadow-[0_18px_40px_rgba(15,23,42,0.22)]">
            <div class="flex items-center justify-center gap-4">
              <div class="grid place-items-center size-12 rounded-2xl bg-white/10 border border-white/15">
                <svg id="iconSvg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="opacity-95">
                  <path d="M8 5v14l11-7z"></path>
                </svg>
              </div>
              <div class="text-left">
                <div id="btnLabel" class="text-xl font-semibold">Start</div>
                <div id="btnSub" class="text-xs text-white/75">ã‚¿ãƒƒãƒ—ã§å†ç”Ÿ</div>
              </div>
            </div>
          </button>

          <!-- çŠ¶æ…‹ -->
          <div class="mt-4">
            <div class="rounded-2xl bg-white/75 border border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-xs text-slate-500">çŠ¶æ…‹</div>
                <div id="statusChip" class="text-[11px] text-slate-500 tabular-nums">â€”</div>
              </div>
              <div id="statusMain" class="mt-1 text-base font-medium text-slate-800">å¾…æ©Ÿä¸­</div>
              <div id="statusSub" class="mt-0.5 text-[12px] text-slate-600">â€”</div>
            </div>
          </div>
        </div>

        <div class="border-t border-white/70 bg-white/55">
          <div class="px-6 sm:px-8 py-4 flex items-center justify-between gap-3">
            <button id="btnRefresh"
              class="px-4 py-2 rounded-2xl text-sm bg-white/80 border border-slate-200 hover:bg-white active:scale-[0.99]">
              æ›´æ–°
            </button>

            <details id="settingsDetails" class="group">
              <summary
                class="list-none cursor-pointer select-none px-4 py-2 rounded-2xl text-sm
                       bg-white/80 border border-slate-200 hover:bg-white active:scale-[0.99]
                       inline-flex items-center gap-2">
                è¨­å®š
                <span class="text-slate-400 group-open:rotate-180 transition">â–¾</span>
              </summary>
            </details>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Settings Overlay -->
  <div id="settingsOverlay" class="fixed inset-0 z-50 hidden">
    <div id="settingsBackdrop" class="absolute inset-0 bg-slate-900/10 backdrop-blur-[2px]"></div>

    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6">
      <div class="w-full max-w-[560px] rounded-[28px] bg-white/95 border border-slate-200 shadow-2xl overflow-hidden">
        <!-- header -->
        <div class="px-5 sm:px-6 pt-4 pb-3 border-b border-slate-200">
          <div class="flex items-center justify-between gap-3">
            <div class="text-sm font-semibold text-slate-800">è¨­å®š</div>
            <button id="btnCloseSettings"
              class="px-3 py-1.5 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800 active:scale-[0.99]">
              é–‰ã˜ã‚‹
            </button>
          </div>

          <!-- Tabs -->
          <div class="mt-3 flex gap-2">
            <button data-tab="tabSettings"
              class="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 bg-slate-900 text-white">
              è¨­å®š
            </button>
            <button data-tab="tabGuide"
              class="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">
              ä»•çµ„ã¿
            </button>
          </div>
        </div>

        <!-- body -->
        <div class="px-5 sm:px-6 py-4 max-h-[70vh] overflow-y-auto ios-scroll">
          <!-- ===== Tab: Settings ===== -->
          <section id="tabSettings">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <div class="text-xs text-slate-500 mb-1">å­£ç¯€</div>
                <select id="seasonSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                  <option value="auto">Auto</option>
                  <option value="spring">æ˜¥</option>
                  <option value="summer">å¤</option>
                  <option value="autumn">ç§‹</option>
                  <option value="winter">å†¬</option>
                </select>
              </div>
              <div>
                <div class="text-xs text-slate-500 mb-1">æ™‚é–“</div>
                <select id="timeSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                  <option value="auto">Auto</option>
                  <option value="morning">æœ</option>
                  <option value="day">æ˜¼</option>
                  <option value="evening">å¤•</option>
                  <option value="night">å¤œ</option>
                  <option value="late">æ·±å¤œ</option>
                </select>
              </div>
              <div>
                <div class="text-xs text-slate-500 mb-1">å¤©æ°—</div>
                <select id="weatherSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
                  <option value="auto">Auto</option>
                  <option value="clear">æ™´ã‚Œ</option>
                  <option value="rain">é›¨</option>
                  <option value="other">ãã®ä»–</option>
                </select>
              </div>
            </div>
          </section>

          <!-- ===== Tab: Guide ===== -->
          <section id="tabGuide" class="hidden">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="text-sm font-semibold text-slate-800">ã“ã®ã‚¢ãƒ—ãƒªã®ä»•çµ„ã¿</div>
              <p class="mt-2 text-sm text-slate-700 leading-relaxed">
                è‡ªç„¶ã®å€¤ã‚’ãã®ã¾ã¾éŸ³é‡ã«çµã³ã¤ã‘ã‚‹ã®ã§ã¯ãªãã€å¿ƒåœ°ã‚ˆã•ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å®ˆã‚ŠãªãŒã‚‰ã€ã‚­ãƒ¼ã‚„ãƒ†ãƒ³ãƒã€å…‰ã®æ˜ã‚‹ã•ã€ãã‚‰ã‚ãã®å¯†åº¦ã¸ã¨ãã£ã¨ç¹”ã‚Šè¾¼ã‚“ã§ã„ã¾ã™ã€‚
              </p>
            </div>

            <div class="mt-3 space-y-3">
              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">å­£ç¯€ï¼ˆã‚­ãƒ¼ï¼šèª¿ï¼‰</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  æ˜¥ã¯Cã€å¤ã¯Dã€ç§‹ã¯Ebã€å†¬ã¯Aã€‚<br>
                  å­£ç¯€ã”ã¨ã«ãã£ã¨åŸºèª¿ã¨ãªã‚‹ã‚­ãƒ¼ã‚’å®šã‚ã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼ã¨ãã‚‰ã‚ãã¯å¸¸ã«åŒã˜èª¿ã®ä¸­ã§æºã‚‰ããŸã‚ã€éŸ³ã®ä¸–ç•ŒãŒå´©ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                </div>
              </details>

              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">æ™‚é–“ï¼ˆãƒ†ãƒ³ãƒãƒ»ç©ºæ°—æ„Ÿï¼‰</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  æœã¨æ˜¼ã¯ã€ã‚ãšã‹ã«é€Ÿãã€‚å¤œã¨æ·±å¤œã¯ã€ã‚†ã£ãã‚Šã¨ã€‚ä½“æ„Ÿã®â€œå‘¼å¸â€ã‚’æ™‚é–“å¸¯ã«å¯„ã›ãªãŒã‚‰ã€èƒŒæ™¯ã®ç™½ã‚‚é™ã‹ã«ç§»ã‚ã„ã¾ã™ã€‚
                </div>
              </details>

              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">å¤©æ°—ï¼ˆæ˜ã‚‹ã•ãƒ»æ®‹éŸ¿ï¼‰</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  æ™´ã‚Œã®æ—¥ã¯ã€å…‰ã‚’ã²ã‚‰ãã‚ˆã†ã«æ˜ã‚‹ãã€‚ä½™éŸ»ã¯è»½ã‚„ã‹ã«æ•´ãˆã€ç©ºæ°—ã‚’æ¾„ã¾ã›ã¾ã™ã€‚é›¨ã®æ—¥ã¯ã€å°‘ã—ã ã‘é™°å½±ã‚’æ·±ã‚ã¦ã€‚æ®‹éŸ¿ã‚’é‡ã­ã€ã—ã£ã¨ã‚Šã¨ã—ãŸä½™ç™½ã‚’ã¾ã¨ã‚ã›ã¦ã„ã¾ã™ã€‚
                </div>
              </details>

              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">é¢¨ï¼ˆã‚†ã‚‰ãï¼šãã‚‰ã‚ãå¯†åº¦ï¼‰</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  é¢¨ãŒå¼·ã¾ã‚‹ã»ã©ã€ãã‚‰ã‚ãã¯ã‚ãšã‹ã«å¢—ãˆã¦ã„ãã¾ã™ã€‚<br>
                  ã‘ã‚Œã©æ±ºã—ã¦é¨’ãŒã—ãã¯ãªã‚‰ãªã„ã‚ˆã†ã«ã€‚ç¬ããŒå°‘ã—ã ã‘å¢—ãˆã‚‹ã€ãã®ãã‚‰ã„ã®ä½™ç™½ã«ã¨ã©ã‚ã¦ã„ã¾ã™ã€‚
                </div>
              </details>

              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">UVï¼ˆæ˜¼ã®å…‰ï¼šæ˜ã‚‹ã•è£œæ­£ï¼‰</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  å…‰ãŒå¼·ã„æ—¥ä¸­ã¯ã€ç©ºæ°—ã®é€æ˜åº¦ã‚’å°‘ã—é«˜ã‚ã€ä½™éŸ»ã‚’å¼•ãç· ã‚ã¾ã™ã€‚<br>
                  ãã‚‰ã‚Šã¨å·®ã—è¾¼ã‚€å…‰ã®æ„Ÿè§¦ã‚’æ·»ãˆã¦ã€æ˜¼ã®å¿ƒåœ°ã‚ˆã•ã‚’ãã£ã¨æŠ¼ã—ä¸Šã’ã¾ã™ã€‚
                </div>
              </details>

              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">é³¥ï¼ˆå›€ã‚Šï¼‰</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  æœã‹ã‚‰æ˜¼ã«ã‹ã‘ã¦ã¯ã€æ™¯è‰²ã®â€œæ°—é…â€ã¨ã—ã¦å›€ã‚Šã‚’ã»ã‚“ã®å°‘ã—ã ã‘æ·»ãˆã¦ã„ã¾ã™ã€‚ä¸»å½¹ã«ãªã‚‰ãªã„ã‚ˆã†ã€çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã¨å˜ç™ºã‚’ç¹”ã‚Šäº¤ãœãªãŒã‚‰ã€ç©ºæ°—ã«è‡ªç„¶ã¨æº¶ã‘è¾¼ã‚€ç¯„å›²ã«ã¨ã©ã‚ã¦ã„ã¾ã™ã€‚å¤œã¨æ·±å¤œã¯ã€ãã®é™ã‘ã•ã‚’ä½•ã‚ˆã‚Šã‚‚å„ªå…ˆã—ã¾ã™ã€‚
                </div>
              </details>

              <details class="rounded-2xl border border-slate-200 bg-white p-4">
                <summary class="cursor-pointer select-none flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-800">ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼</span>
                  <span class="text-slate-400">â–¾</span>
                </summary>
                <div class="mt-3 text-sm text-slate-700 leading-relaxed">
                  éŸ¿ãã¯ã€ãã®èª¿ã®ä¸­ã§ã‚‚ç©ã‚„ã‹ãªä¸‰å’ŒéŸ³ã ã‘ã‚’é¸ã³ã€ä¸å®‰å®šã•ã‚’ç”Ÿã‚€å’ŒéŸ³ã¯ã‚ãˆã¦ç”¨ã„ã¾ã›ã‚“ã€‚å®‰å¿ƒã—ã¦èº«ã‚’é ã‘ã‚‰ã‚Œã‚‹éŸ¿ãã‚’ç´¡ã„ã§ã„ã¾ã™ã€‚
                </div>
              </details>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // Weather + UV (Open-Meteo)
  // =========================
  const OPEN_METEO_URL = "https://api.open-meteo.com/v1/forecast";
  const AUTO_UPDATE_MS = 5 * 60 * 1000;
  let nextUpdateAt = Date.now() + AUTO_UPDATE_MS;

  function describeWeather(code) {
    if (code === 0) return "å¿«æ™´";
    if ([1,2].includes(code)) return "æ™´ã‚Œ/è–„æ›‡ã‚Š";
    if (code === 3) return "ãã‚‚ã‚Š";
    if ([45,48].includes(code)) return "éœ§";
    if ([51,53,55,56,57].includes(code)) return "éœ§é›¨";
    if ([61,63,65,66,67].includes(code)) return "é›¨";
    if ([71,73,75,77].includes(code)) return "é›ª";
    if ([80,81,82].includes(code)) return "ã«ã‚ã‹é›¨";
    if ([95,96,99].includes(code)) return "é›·é›¨";
    return "ä¸æ˜";
  }

  function weatherCategoryFromCode(code) {
    if (code === 0 || [1,2].includes(code)) return "clear";
    if ([61,63,65,66,67,80,81,82,51,53,55,56,57,95,96,99].includes(code)) return "rain";
    return "other";
  }

  async function fetchWeatherByCoords(lat, lon) {
    const url = new URL(OPEN_METEO_URL);
    url.searchParams.set("latitude", lat);
    url.searchParams.set("longitude", lon);
    url.searchParams.set("current", "weather_code,wind_speed_10m");
    url.searchParams.set("daily", "uv_index_max");
    url.searchParams.set("timezone", "auto");

    const res = await fetch(url.toString());
    if (!res.ok) throw new Error("å¤©æ°—å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    const data = await res.json();

    const code = data?.current?.weather_code;
    const wind = data?.current?.wind_speed_10m;
    const uvArr = data?.daily?.uv_index_max;
    const uv = Array.isArray(uvArr) ? uvArr[0] : null;

    if (typeof code !== "number" || typeof wind !== "number") throw new Error("å¤©æ°—ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæƒ³å®šã¨é•ã„ã¾ã™");
    return { code, wind, uv: (typeof uv === "number" ? uv : null) };
  }

  function getCurrentPosition() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“"));
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: false,
        timeout: 8000,
        maximumAge: 60_000,
      });
    });
  }

  // =========================
  // Wake Lockï¼ˆç”»é¢OFFã§æ­¢ã¾ã‚Šã‚„ã™ã„å¯¾ç­–ï¼‰
  // =========================
  let wakeLock = null;
  async function requestWakeLock(){
    try{
      if (!("wakeLock" in navigator)) return;
      wakeLock = await navigator.wakeLock.request("screen");
      wakeLock.addEventListener("release", () => { wakeLock = null; });
    } catch(e){}
  }
  async function releaseWakeLock(){
    try{ if (wakeLock) await wakeLock.release(); } catch(e){}
    wakeLock = null;
  }
  document.addEventListener("visibilitychange", async () => {
    if (document.visibilityState === "visible" && isRunning){
      await requestWakeLock();
    }
  });

  // =========================
  // Env helpers
  // =========================
  function autoTimeBlock(){
    const h = new Date().getHours();
    if (h >= 5 && h < 10) return "morning";
    if (h >= 10 && h < 16) return "day";
    if (h >= 16 && h < 19) return "evening";
    if (h >= 19 && h < 24) return "night";
    return "late";
  }

  function autoSeason(){
    const m = new Date().getMonth() + 1;
    if (m >= 3 && m <= 5) return "spring";
    if (m >= 6 && m <= 8) return "summer";
    if (m >= 9 && m <= 11) return "autumn";
    return "winter";
  }

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

  function setStatus(main, sub = "â€”") {
    const a = document.getElementById("statusMain");
    const b = document.getElementById("statusSub");
    if (!a || !b) return;
    a.textContent = main;
    b.textContent = sub;
  }

  function setStatusChip(text = "â€”"){
    const el = document.getElementById("statusChip");
    if (!el) return;
    el.textContent = text;
  }

  function applyWhiteByTime(time){
    const map = {
      morning: ["from-sky-50",   "via-white", "to-slate-100"],
      day:     ["from-white",    "via-white", "to-slate-100"],
      evening: ["from-amber-50", "via-white", "to-rose-100"],
      night:   ["from-slate-50", "via-white", "to-slate-200"],
      late:    ["from-slate-50", "via-white", "to-slate-200"],
    };
    const [a,b,c] = map[time] || map.day;
    document.body.className = `min-h-screen text-slate-900 bg-gradient-to-b ${a} ${b} ${c}`;
  }

  // =========================
  // Media Session
  // =========================
  function setMediaSessionMetadata(text){
    if (!("mediaSession" in navigator)) return;
    try{
      navigator.mediaSession.metadata = new MediaMetadata({
        title: "Ambient Music",
        artist: text,
        album: "Nature Sync"
      });

      navigator.mediaSession.setActionHandler("play",  async () => { if (!isRunning) await start(); });
      navigator.mediaSession.setActionHandler("pause", () => { if (isRunning) stop(); });
    } catch(e){}
  }

  function updatePlaybackState(){
    if (!("mediaSession" in navigator)) return;
    try{
      navigator.mediaSession.playbackState = isRunning ? "playing" : "paused";
    } catch(e){}
  }

  // =========================
  // Music
  // =========================
  let isRunning = false;

  // âœ… ã‚‚ã£ã¨ãƒªãƒãƒ¼ãƒ–ã‚’å…¨ä½“ã«ï¼šmasterReverb ã¸é›†ç´„
  let masterReverb, masterComp, masterLimiter;
  let filter; // shared tone color

  // sparkle = rhythm
  let sparkle, sparkleDelay, sparklePanner;
  let bird, birdFilter, birdTremolo;

  let sparkleLoop, birdLoop;
  let chordEventId = null;

  let lastWeather = { code: 0, wind: 0, uv: null };
  let lastRoot = null;

  // âœ… æ­¢ã¾ã‚‰ãªã„åŒ–ã®æ ¸ï¼šå’ŒéŸ³ãƒãƒ¼ãƒ‰ã¨ã‚¿ã‚¤ãƒãƒ¼ã‚’è¿½è·¡ã—ã¦ç¢ºå®Ÿã«æƒé™¤ã™ã‚‹
  const activeChordTimers = new Set();
  const activeChordNodes = new Set();

  function disposeAllChords(){
    activeChordTimers.forEach(tid => { try{ clearTimeout(tid); } catch(e){} });
    activeChordTimers.clear();

    activeChordNodes.forEach(node => { try{ node.dispose(); } catch(e){} });
    activeChordNodes.clear();
  }

  function scheduleDispose(nodeA, nodeB, atAudioTimeSec){
    const now = Tone.now();
    const ms = Math.max(0, (atAudioTimeSec - now) * 1000);

    activeChordNodes.add(nodeA);
    activeChordNodes.add(nodeB);

    const tid = setTimeout(() => {
      try{ nodeA.dispose(); } catch(e){}
      try{ nodeB.dispose(); } catch(e){}
      activeChordNodes.delete(nodeA);
      activeChordNodes.delete(nodeB);
      activeChordTimers.delete(tid);
    }, ms);

    activeChordTimers.add(tid);
  }

  function ensureAudioGraph(){
    if (sparkle) return;

    // âœ… Master chainï¼ˆå…¨ä½“ã«ãƒªãƒãƒ¼ãƒ– + ã»ã‚“ã®å°‘ã—æ•´ãˆã‚‹ï¼‰
    masterReverb = new Tone.Reverb({ decay: 14.5, wet: 0.42 }).toDestination();
    masterComp = new Tone.Compressor({ threshold: -18, ratio: 2.2, attack: 0.01, release: 0.22 }).connect(masterReverb);
    masterLimiter = new Tone.Limiter(-1).connect(masterComp);

    // âœ… ã¾ãšãƒªãƒŸãƒƒã‚¿ã¸é›†ç´„ â†’ comp â†’ reverbï¼ˆéŸ³ãŒæš´ã‚Œã«ãã„ï¼‰
    // ã“ã“ã¸å…¨å“¡ connect ã™ã‚‹
    filter = new Tone.Filter({ type: "lowpass", frequency: 1900, rolloff: -12 }).connect(masterLimiter);

    // =========================
    // Sparkle / Rhythm
    // =========================
    sparkleDelay = new Tone.FeedbackDelay({ delayTime: "16n", feedback: 0.34, wet: 0.40 });
    sparklePanner = new Tone.Panner(0).connect(filter);
    sparkleDelay.connect(sparklePanner);

    sparkle = new Tone.Synth({
      oscillator: { type: "sine" },
      envelope: { attack: 0.01, decay: 0.10, sustain: 0.0, release: 1.4 }
    }).connect(sparkleDelay);
    sparkle.volume.value = -12;

    // =========================
    // Bird
    // =========================
    birdTremolo = new Tone.Tremolo({ frequency: 9, depth: 0.65, wet: 1.0 }).start();
    birdFilter = new Tone.Filter({ type: "bandpass", frequency: 2300, Q: 6 });
    bird = new Tone.Synth({
      oscillator: { type: "sine" },
      envelope: { attack: 0.004, decay: 0.07, sustain: 0.0, release: 0.17 }
    });
    bird.chain(birdTremolo, birdFilter, filter);
    bird.volume.value = -19;
  }

  function keyFromSeason(season){
    if (season === "spring") return "C";
    if (season === "summer") return "D";
    if (season === "autumn") return "Eb";
    if (season === "winter") return "A";
    return "C";
  }

  function chordChoicesForKey(key){
    const map = {
      "C":  ["C4","D4","E4","F4","G4","A4"],
      "D":  ["D4","E4","F#4","G4","A4","B4"],
      "Eb": ["Eb4","F4","G4","Ab4","Bb4","C5"],
      "A":  ["A3","B3","C#4","D4","E4","F#4"]
    };
    return map[key] || map["C"];
  }

  function triad(rootNote){
    const r = Tone.Frequency(rootNote);
    return [ r.toNote(), r.transpose(4).toNote(), r.transpose(7).toNote() ];
  }

  function sparkleScale(key, weatherCat, time){
    const major = {
      "C":  ["C5","D5","E5","F5","G5","A5","B5","C6"],
      "D":  ["D5","E5","F#5","G5","A5","B5","C#6","D6"],
      "Eb": ["Eb5","F5","G5","Ab5","Bb5","C6","D6","Eb6"],
      "A":  ["A4","B4","C#5","D5","E5","F#5","G#5","A5"],
    };
    const pent = {
      "C":  ["C5","D5","E5","G5","A5","C6"],
      "D":  ["D5","E5","F#5","A5","B5","D6"],
      "Eb": ["Eb5","F5","G5","Bb5","C6","Eb6"],
      "A":  ["A4","B4","C#5","E5","F#5","A5"],
    };
    const usePent = (weatherCat === "rain") || (time === "night" || time === "late");
    return usePent ? (pent[key] || pent["C"]) : (major[key] || major["C"]);
  }

  function randomBetween(min, max){ return min + Math.random() * (max - min); }
  function randInt(min, max){ return Math.floor(min + Math.random() * (max - min + 1)); }
  function choose(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

  function getEnv(){
    const seasonSel = document.getElementById("seasonSel").value;
    const timeSel   = document.getElementById("timeSel").value;
    const weatherSel= document.getElementById("weatherSel").value;

    const season = (seasonSel === "auto") ? autoSeason() : seasonSel;
    const time   = (timeSel === "auto") ? autoTimeBlock() : timeSel;
    const weatherCat = (weatherSel === "auto") ? weatherCategoryFromCode(lastWeather.code) : weatherSel;

    return { season, time, weatherCat };
  }

  function prettyTimeLabel(t){
    if (t === "morning") return "æœ";
    if (t === "day") return "æ˜¼";
    if (t === "evening") return "å¤•";
    if (t === "night") return "å¤œ";
    if (t === "late") return "æ·±å¤œ";
    return t;
  }
  function prettyWeatherLabel(w){
    if (w === "clear") return "æ™´ã‚Œ";
    if (w === "rain") return "é›¨";
    if (w === "other") return "ãã®ä»–";
    return w;
  }

  function applyParams(){
    const env = getEnv();
    const key = keyFromSeason(env.season);

    applyWhiteByTime(env.time);

    let bpm = 66;
    if (env.time === "morning") bpm = 74;
    if (env.time === "day") bpm = 78;
    if (env.time === "evening") bpm = 70;
    if (env.time === "night") bpm = 60;
    if (env.time === "late") bpm = 54;
    Tone.Transport.bpm.value = bpm;

    // filter + reverb feel
    let cutoff = 1900, wet = 0.42, decay = 14.5;
    if (env.weatherCat === "clear") { cutoff = 2800; wet = 0.34; decay = 12.0; }
    if (env.weatherCat === "other") { cutoff = 1900; wet = 0.44; decay = 14.0; }
    if (env.weatherCat === "rain")  { cutoff = 1350; wet = 0.52; decay = 16.5; }

    const uv = (typeof lastWeather.uv === "number") ? lastWeather.uv : null;
    const isDay = (env.time === "day" || env.time === "morning" || env.time === "evening");
    if (uv !== null && isDay){
      const u = clamp(uv / 11, 0, 1);
      cutoff += 560 * u;
      wet    -= 0.06 * u;
      decay  -= 1.2 * u;
    }

    filter.frequency.value = clamp(cutoff, 950, 3600);
    masterReverb.wet.value = clamp(wet, 0.28, 0.70);
    masterReverb.decay = clamp(decay, 9.0, 20.0);

    if (birdFilter){
      birdFilter.frequency.value = (env.weatherCat === "rain") ? 1950 : 2350;
    }

    const windText = `${(lastWeather.wind ?? 0).toFixed(1)} m/s`;
    const uvText = (uv === null) ? "â€”" : uv.toFixed(1);
    setMediaSessionMetadata(`${env.season} / ${env.weatherCat} / wind ${windText} / UV ${uvText}`);

    const sub = `Key ${key} Â· ${prettyTimeLabel(env.time)} Â· ${prettyWeatherLabel(env.weatherCat)} Â· é¢¨ ${(lastWeather.wind ?? 0).toFixed(1)} Â· UV ${uvText}`;
    setStatusChip(describeWeather(lastWeather.code));
    if (isRunning) setStatus("å†ç”Ÿä¸­", sub);

    return { ...env, key, bpm };
  }

  function clearHarmonyScheduler(){
    if (chordEventId !== null){
      try { Tone.Transport.clear(chordEventId); } catch(e){}
      chordEventId = null;
    }
  }

  // âœ… ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼ã®ã€Œé•·ã•ã¯ç¶­æŒã€ã—ã¤ã¤ã€Œé »åº¦ã ã‘å¢—ã‚„ã™ã€ï¼šgapã ã‘çŸ­ãã™ã‚‹
  function harmonyGapSeconds(r){
    // ã„ã¾ã®é•·ã•æ„Ÿã‚’ä¿ã¡ã¤ã¤ã€å‡ºç¾é »åº¦ã‚¢ãƒƒãƒ—ï¼ˆgapã‚’ç¸®ã‚ã‚‹ï¼‰
    let g = randomBetween(1.4, 4.2); // æ—§ 3ã€œ8 ã‚ˆã‚ŠçŸ­ã„
    if (r.time === "late") g *= 1.25;
    if (r.time === "night") g *= 1.10;
    if (r.weatherCat === "rain") g *= 1.15;
    return clamp(g, 1.2, 6.0);
  }

  // âœ… ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼ã®éŸ³ç¨‹ã®é«˜ä½ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ï¼ˆÂ±1ã€œ2octï¼‰
  function octaveShifted(note, octShift){
    const f = Tone.Frequency(note);
    return f.transpose(12 * octShift).toNote();
  }

  function playOneHarmony(startTime, r){
    const choices = chordChoicesForKey(r.key);

    let root = choices[Math.floor(Math.random() * choices.length)];
    if (root === lastRoot) root = choices[Math.floor(Math.random() * choices.length)];
    lastRoot = root;

    // é•·ã•ã¯ç¶­æŒï¼ˆ26ã€œ52sï¼‰
    const playDur = randomBetween(26.0, 52.0);
    // gapã ã‘çŸ­ç¸®ã—ã¦é »åº¦å¢—
    const gapDur  = harmonyGapSeconds(r);

    // octave shift: -1, 0, +1, ãŸã¾ã« +2 / -2
    let oct = choose([-1, 0, 0, 0, +1, +1]);
    if (Math.random() < 0.10) oct = choose([-2, +2]);

    const shiftedRoot = octaveShifted(root, oct);

    const chordGain = new Tone.Gain(0.000001).connect(filter);
    const chordPad = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "sine" },
      envelope: { attack: 2.2, decay: 0.6, sustain: 0.82, release: 18.0 }
    }).connect(chordGain);

    // harmony éŸ³é‡
    chordPad.volume.value = -18;

    // peakï¼ˆéå¤§ã«ãªã‚‰ãªã„ã‚ˆã†æ§ãˆã‚ï¼‰
    let peak = 0.15 + Math.random() * 0.17; // 0.15ã€œ0.32
    if (r.time === "night" || r.time === "late") peak *= 0.78;
    if (r.weatherCat === "rain") peak *= 0.86;

    const t0 = startTime;
    const tPeak = startTime + playDur * (0.35 + Math.random() * 0.35);
    const tEnd = startTime + playDur;

    chordGain.gain.setValueAtTime(0.00012, t0);
    chordGain.gain.exponentialRampToValueAtTime(Math.max(0.00018, peak), tPeak);
    chordGain.gain.exponentialRampToValueAtTime(0.00012, tEnd);

    // triadã‚‚åŒã˜octã§ã‚ºãƒ©ã™ï¼ˆrootã®octã‚’åæ˜ ï¼‰
    const tri = triad(shiftedRoot);
    chordPad.triggerAttackRelease(tri, playDur, startTime, 0.72);

    const disposeAt = tEnd + 22.0;
    scheduleDispose(chordPad, chordGain, disposeAt);

    const nextTime = startTime + playDur + gapDur;
    chordEventId = Tone.Transport.scheduleOnce((t) => {
      const rr = applyParams();
      playOneHarmony(t, rr);
    }, nextTime);
  }

  // =========================
  // Sparkle: delayã‚’ã€Œ4ã€œ5ã¤ä»¥ä¸Šã€ãƒ©ãƒ³ãƒ€ãƒ ã«ç©ã‚€ï¼ˆMultiTapï¼‰
  // =========================
  function buildMultiTapDelay(){
    // æ—¢å­˜ã‚’æƒé™¤
    if (sparkleDelay) { try{ sparkleDelay.dispose(); }catch(e){} }
    // pannerå´ã®æ¥ç¶šã¯ä½œã‚Šç›´ã™
    if (sparklePanner) { try{ sparklePanner.dispose(); }catch(e){} }

    // æ–°ã—ã„ panner
    sparklePanner = new Tone.Panner(0).connect(filter);

    const taps = randInt(4, 7); // 4ã€œ5ä»¥ä¸Šï¼ˆæœ€å¤§7ï¼‰
    const merger = new Tone.Gain(1).connect(sparklePanner);

    // ã€Œãƒ‡ã‚£ãƒ¬ã‚¤ã‚’ã‚‚ã£ã¨ã¤ã‘ã¦ã€ï¼wet/feedbackã‚‚å°‘ã—ä¸Šã’ã‚‹
    const wetBase = randomBetween(0.40, 0.62);

    const tapNodes = [];
    for (let i = 0; i < taps; i++){
      const dt = randomBetween(0.03, 0.23);              // ç§’ï¼ˆå¾®ç´°ï¼†ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
      const fb = randomBetween(0.18, 0.44) * (1 - i*0.08); // å¾Œæ®µã»ã©æ§ãˆã‚
      const wt = clamp(wetBase * (0.85 - i*0.06), 0.18, 0.65);

      const d = new Tone.FeedbackDelay({ delayTime: dt, feedback: fb, wet: wt });
      d.connect(merger);
      tapNodes.push(d);
    }

    // å…¥åŠ›ã¨ã—ã¦ã¾ã¨ã‚ã‚‹
    const input = new Tone.Gain(1);
    tapNodes.forEach(d => input.connect(d));

    // è¿”å´ï¼šsparkleSynthã¯ input ã«ç¹‹ã
    return { input, taps, wetBase, tapNodes };
  }

  let sparkleMulti = null;

  function pickSparkleDelayRefreshChance(r){
    // å¤‰åŒ–ã—ã™ãã‚‹ã¨ä¸è‡ªç„¶ãªã®ã§ã€ãŸã¾ã«çµ„ã¿æ›¿ãˆã‚‹
    if (r.time === "day") return 0.06;
    if (r.time === "morning") return 0.05;
    if (r.time === "evening") return 0.04;
    if (r.time === "night") return 0.03;
    return 0.02;
  }

  function rebuildSparkleDelayIfNeeded(r){
    if (!sparkleMulti){
      sparkleMulti = buildMultiTapDelay();
      sparkle.disconnect();
      sparkle.connect(sparkleMulti.input);
      return;
    }
    if (Math.random() < pickSparkleDelayRefreshChance(r)){
      // çµ„ã¿æ›¿ãˆ
      sparkleMulti.tapNodes.forEach(n => { try{ n.dispose(); } catch(e){} });
      try{ sparkleMulti.input.dispose(); } catch(e){}
      sparkleMulti = buildMultiTapDelay();
      sparkle.disconnect();
      sparkle.connect(sparkleMulti.input);
    }
  }

  function rebuildLoops(){
    disposeAllChords();
    Tone.Transport.cancel(0);

    if (sparkleLoop) { sparkleLoop.dispose(); sparkleLoop = null; }
    if (birdLoop) { birdLoop.dispose(); birdLoop = null; }
    clearHarmonyScheduler();

    const r = applyParams();

    // harmony start
    const startAt = Tone.Transport.seconds + 0.1;
    chordEventId = Tone.Transport.scheduleOnce((t) => playOneHarmony(t, r), startAt);

    // âœ… multi-tap delay ã‚’åˆå›ç”Ÿæˆ
    rebuildSparkleDelayIfNeeded(r);

    // Sparkle / Rhythm
    const sparkleInterval = 0.52; // å°‘ã—ã ã‘å¯†åº¦UP
    sparkleLoop = new Tone.Loop((time) => {
      // çŠ¶æ³ã«å¿œã˜ã¦ã€ã¨ãã©ããƒ‡ã‚£ãƒ¬ã‚¤æ§‹é€ ã‚’çµ„ã¿æ›¿ãˆ
      rebuildSparkleDelayIfNeeded(r);

      const scale = sparkleScale(r.key, r.weatherCat, r.time);

      let p = 0.60;
      if (r.weatherCat === "rain") p = 0.50;
      if (r.time === "late") p = 0.36;
      if (r.time === "night") p = Math.min(p, 0.44);
      if (r.weatherCat === "clear" && (r.time === "day" || r.time === "morning")) p = 0.70;

      const windBoost = clamp(((lastWeather.wind ?? 0) - 2) / 10, 0, 0.14);
      p += windBoost;

      const uv = (typeof lastWeather.uv === "number") ? lastWeather.uv : null;
      if (uv !== null && (r.time === "day" || r.time === "morning")){
        const u = clamp(uv / 11, 0, 1);
        p += 0.12 * u;
      }
      p = clamp(p, 0.14, 0.82);

      if (Math.random() < p){
        const pan = (Math.random() * 1.7) - 0.85;
        sparklePanner.pan.cancelScheduledValues(time);
        sparklePanner.pan.setValueAtTime(sparklePanner.pan.value, time);
        sparklePanner.pan.linearRampToValueAtTime(pan, time + 0.06);

        const note = scale[Math.floor(Math.random() * scale.length)];
        if (Math.random() < 0.16){
          const note2 = scale[Math.floor(Math.random() * scale.length)];
          sparkle.triggerAttackRelease(note, 0.12, time, 0.44);
          sparkle.triggerAttackRelease(note2, 0.12, time + 0.02, 0.36);
        } else {
          sparkle.triggerAttackRelease(note, 0.12, time, 0.44);
        }

        // âœ… 4ã€œ5ä»¥ä¸Šã®å¤šæ®µãƒ‡ã‚£ãƒ¬ã‚¤ãŒã€Œå¾Œã‚ã§å‹æ‰‹ã«é³´ã‚‹ã€ã®ã§ã€ã“ã“ã§è¿½åŠ ç™ºéŸ³ã¯æ§ãˆã‚ã«
      }
    }, sparkleInterval).start(0);

    // =========================
    // ğŸ¦ Bird (chirp) - å¢—ã‚„ã™
    // =========================
    function birdChance(){
      let base = 0.08; // æ—§ 0.045 â†’ å¢—

      if (r.time === "morning") base = 0.18;
      if (r.time === "day")     base = 0.26;
      if (r.time === "evening") base = 0.14;
      if (r.time === "night")   base = 0.04;
      if (r.time === "late")    base = 0.018;

      if (r.weatherCat === "rain")  base *= 0.70;
      if (r.weatherCat === "clear" && (r.time === "day" || r.time === "morning")) base *= 1.10;

      const w = clamp(lastWeather.wind ?? 0, 0, 15);
      base *= (1.0 + 0.12 * (w / 15));

      const uv = (typeof lastWeather.uv === "number") ? lastWeather.uv : null;
      if (uv !== null && r.time === "day") {
        const u = clamp(uv / 11, 0, 1);
        base *= (1.0 + 0.12 * u);
      }

      return clamp(base, 0.010, 0.40);
    }

    function chirp(time, amp = 0.30){
      const base = 1450 + Math.random()*700;
      const up   = base + 980 + Math.random()*560;
      const dur  = 0.055 + Math.random()*0.070;

      bird.frequency.setValueAtTime(base, time);
      bird.frequency.linearRampToValueAtTime(up, time + dur);
      bird.frequency.linearRampToValueAtTime(base + 240, time + dur + 0.03);

      bird.triggerAttackRelease("C6", dur + 0.06, time, amp);
    }

    function phrase(time){
      const n = (Math.random() < 0.50) ? 2 : (Math.random() < 0.80 ? 3 : 5); // ãŸã¾ã«5
      const baseGap = 0.10 + Math.random()*0.09;

      for (let i = 0; i < n; i++){
        const t = time + i*(baseGap + Math.random()*0.06);
        const amp = 0.26 + Math.random()*0.12;
        chirp(t, amp);
      }
    }

    function birdLoopIntervalSeconds(){
      if (r.time === "day") return 1.55;     // æ—§ 1.9
      if (r.time === "morning") return 1.70; // æ—§ 2.1
      if (r.time === "evening") return 2.05; // æ—§ 2.4
      if (r.time === "night") return 2.80;   // æ—§ 3.2
      return 3.40;                           // æ—§ 4.0
    }

    birdLoop = new Tone.Loop((time) => {
      if (!bird) return;

      const p = birdChance();
      if (Math.random() < p){
        if (r.time === "night" || r.time === "late"){
          // å¤œã§ã‚‚ã€Œå°‘ã—å¢—ã‚„ã™ã€ã‘ã©æ§ãˆã‚
          chirp(time, 0.23);
          if (Math.random() < 0.22) chirp(time + 0.16 + Math.random()*0.10, 0.21);
          return;
        }

        const roll = Math.random();
        if (roll < 0.46){
          chirp(time, 0.28 + Math.random()*0.10);
          if (Math.random() < (r.time === "day" ? 0.62 : 0.46)){
            chirp(time + 0.12 + Math.random()*0.12, 0.24 + Math.random()*0.10);
          }
        } else if (roll < 0.80){
          const n = (Math.random() < 0.55) ? 2 : 4; // å¤šã‚
          for (let i=0; i<n; i++){
            chirp(time + i*(0.11 + Math.random()*0.10), 0.23 + Math.random()*0.12);
          }
        } else {
          phrase(time);
        }
      }
    }, birdLoopIntervalSeconds()).start(0);
  }

  function setButtonState(){
    const dot = document.getElementById("dot");
    const modeText = document.getElementById("modeText");
    const btn = document.getElementById("btnToggle");
    const label = document.getElementById("btnLabel");
    const sub = document.getElementById("btnSub");
    const iconSvg = document.getElementById("iconSvg");

    if (isRunning){
      dot.className = "inline-block size-2 rounded-full bg-emerald-500";
      modeText.textContent = "Playing";
      btn.classList.remove("bg-slate-900","hover:bg-slate-800");
      btn.classList.add("bg-rose-600","hover:bg-rose-500");
      label.textContent = "Stop";
      sub.textContent = "ã‚¿ãƒƒãƒ—ã§åœæ­¢";
      iconSvg.innerHTML = '<path d="M6 6h5v12H6zM13 6h5v12h-5z"></path>';
    } else {
      dot.className = "inline-block size-2 rounded-full bg-slate-400";
      modeText.textContent = "Ready";
      btn.classList.remove("bg-rose-600","hover:bg-rose-500");
      btn.classList.add("bg-slate-900","hover:bg-slate-800");
      label.textContent = "Start";
      sub.textContent = "ã‚¿ãƒƒãƒ—ã§å†ç”Ÿ";
      iconSvg.innerHTML = '<path d="M8 5v14l11-7z"></path>';
      setStatusChip("â€”");
      setStatus("å¾…æ©Ÿä¸­", "â€”");
    }
    updatePlaybackState();
  }

  async function start(){
    ensureAudioGraph();
    Tone.Destination.mute = false;
    await Tone.start();
    await requestWakeLock();

    Tone.Transport.start();
    rebuildLoops();
    isRunning = true;
    setButtonState();
    applyParams();
  }

  function stop(){
    isRunning = false;
    Tone.Destination.mute = true;

    clearHarmonyScheduler();
    if (sparkleLoop) { sparkleLoop.stop(); sparkleLoop.dispose(); sparkleLoop = null; }
    if (birdLoop)    { birdLoop.stop(); birdLoop.dispose(); birdLoop = null; }

    Tone.Transport.stop();
    Tone.Transport.cancel(0);

    disposeAllChords();

    // âœ… multi-tap ã‚‚æƒé™¤
    if (sparkleMulti){
      sparkleMulti.tapNodes.forEach(n => { try{ n.dispose(); } catch(e){} });
      try{ sparkleMulti.input.dispose(); } catch(e){}
      sparkleMulti = null;
    }

    setStatusChip(describeWeather(lastWeather.code));
    setStatus("åœæ­¢ä¸­", "â€”");
    setButtonState();

    releaseWakeLock();
  }

  async function refreshWeather(){
    try{
      setStatusChip("â€”");
      setStatus("å–å¾—ä¸­â€¦", "å¤©æ°—/é¢¨/UV");

      const pos = await getCurrentPosition();
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      const { code, wind, uv } = await fetchWeatherByCoords(lat, lon);
      lastWeather = { code, wind, uv };

      nextUpdateAt = Date.now() + AUTO_UPDATE_MS;

      applyParams();

      if (isRunning){
        rebuildLoops();
        applyParams();
      } else {
        const env = getEnv();
        const key = keyFromSeason(env.season);
        const uvText = (typeof lastWeather.uv === "number") ? lastWeather.uv.toFixed(1) : "â€”";
        const sub = `Key ${key} Â· ${prettyTimeLabel(env.time)} Â· ${prettyWeatherLabel(env.weatherCat)} Â· é¢¨ ${(lastWeather.wind ?? 0).toFixed(1)} Â· UV ${uvText}`;
        setStatusChip(describeWeather(lastWeather.code));
        setStatus("å¾…æ©Ÿä¸­", sub);
      }
    } catch(e){
      console.error(e);
      setStatusChip("â€”");
      setStatus("ã‚¨ãƒ©ãƒ¼", e.message);
    }
  }

  function tick(){
    const remain = Math.max(0, nextUpdateAt - Date.now());
    const mm = String(Math.floor(remain/60000)).padStart(2,"0");
    const ss = String(Math.floor((remain%60000)/1000)).padStart(2,"0");
    document.getElementById("countdown").textContent = `${mm}:${ss}`;
    if (remain === 0) refreshWeather();
    requestAnimationFrame(tick);
  }

  // =========================
  // Settings overlay + Tabs
  // =========================
  const settingsDetails = document.getElementById("settingsDetails");
  const settingsOverlay = document.getElementById("settingsOverlay");
  const settingsBackdrop = document.getElementById("settingsBackdrop");
  const btnCloseSettings = document.getElementById("btnCloseSettings");

  const tabButtons = Array.from(document.querySelectorAll(".tabBtn"));
  const tabSettings = document.getElementById("tabSettings");
  const tabGuide = document.getElementById("tabGuide");

  function setTab(id){
    const isSettings = (id === "tabSettings");
    tabSettings.classList.toggle("hidden", !isSettings);
    tabGuide.classList.toggle("hidden", isSettings);

    tabButtons.forEach(btn => {
      const active = btn.dataset.tab === id;
      btn.className =
        "tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 " +
        (active
          ? "bg-slate-900 text-white"
          : "bg-white text-slate-700 hover:bg-slate-50");
    });
  }

  function openSettings(){
    settingsOverlay.classList.remove("hidden");
    settingsDetails.open = false;
    document.documentElement.classList.add("overflow-hidden");
    document.body.classList.add("overflow-hidden");
    setTab("tabSettings");
  }

  function closeSettings(){
    settingsOverlay.classList.add("hidden");
    document.documentElement.classList.remove("overflow-hidden");
    document.body.classList.remove("overflow-hidden");
  }

  settingsDetails.addEventListener("toggle", () => {
    if (settingsDetails.open) openSettings();
  });

  btnCloseSettings.addEventListener("click", closeSettings);
  settingsBackdrop.addEventListener("click", closeSettings);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSettings();
  });

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => setTab(btn.dataset.tab));
  });

  // UI events
  document.getElementById("btnToggle").addEventListener("click", async () => {
    if (!isRunning) await start();
    else stop();
  });

  document.getElementById("btnRefresh").addEventListener("click", () => refreshWeather());

  ["seasonSel","timeSel","weatherSel"].forEach(id => {
    document.getElementById(id).addEventListener("change", () => {
      applyParams();
      if (isRunning) rebuildLoops();
      applyParams();
    });
  });

  // init
  setButtonState();
  applyWhiteByTime(autoTimeBlock());
  refreshWeather();
  tick();
</script>
</body>
</html>
