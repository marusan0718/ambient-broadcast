<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambient Weather Synth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tone.js (cdnjs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.3.5/Tone.js"></script>
</head>

<body class="min-h-screen transition-colors duration-700">
  <main class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-xl rounded-3xl bg-white/70 backdrop-blur shadow-xl border border-white/60 p-6">
      <header class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-xl font-semibold tracking-tight">Ambient Weather</h1>
          <p class="text-sm text-slate-600">風と天気で“自然と同期”するシンセ</p>
        </div>

        <div class="flex gap-2">
          <button id="btnRefresh" class="px-3 py-2 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800 active:scale-[0.99]">
            更新
          </button>
          <button id="btnToggle" class="px-3 py-2 rounded-xl text-sm bg-emerald-600 text-white hover:bg-emerald-500 active:scale-[0.99]">
            Start
          </button>
        </div>
      </header>

      <section class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="rounded-2xl bg-white/70 border border-slate-200 p-4">
          <div class="text-xs text-slate-500">天気</div>
          <div id="weatherText" class="mt-1 text-lg font-medium">—</div>
          <div class="mt-2 text-xs text-slate-500">天気コード: <span id="weatherCode">—</span></div>
        </div>

        <div class="rounded-2xl bg-white/70 border border-slate-200 p-4">
          <div class="text-xs text-slate-500">風速</div>
          <div class="mt-1 text-lg font-medium"><span id="windSpeed">—</span> m/s</div>
          <div class="mt-2 text-xs text-slate-500">発音密度(目安): <span id="density">—</span></div>
        </div>

        <div class="sm:col-span-2 rounded-2xl bg-white/70 border border-slate-200 p-4">
          <div class="text-xs text-slate-500">ステータス</div>
          <div id="status" class="mt-1 text-sm text-slate-700">待機中（Startで音が鳴る）</div>

          <details class="mt-3">
            <summary class="cursor-pointer text-sm text-slate-700 select-none">位置情報が使えない場合（手入力）</summary>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
              <input id="lat" class="rounded-xl border border-slate-300 px-3 py-2 text-sm" placeholder="lat (例: 35.681)" />
              <input id="lon" class="rounded-xl border border-slate-300 px-3 py-2 text-sm" placeholder="lon (例: 139.767)" />
              <button id="btnUseManual" class="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm hover:bg-slate-800">
                この座標で取得
              </button>
            </div>
          </details>
        </div>
      </section>

      <footer class="mt-5 text-xs text-slate-500">
        Open-Meteo（キー不要）で現在天気を取得し、Tone.jsでリアルタイム生成。
      </footer>
    </div>
  </main>

<script>
  // ---------------------------
  // 1) Open-Meteo: current weather
  // ---------------------------
  const OPEN_METEO_URL = "https://api.open-meteo.com/v1/forecast";

  function describeWeather(code) {
    if (code === 0) return "快晴";
    if ([1,2].includes(code)) return "晴れ/薄曇り";
    if (code === 3) return "くもり";
    if ([45,48].includes(code)) return "霧";
    if ([51,53,55,56,57].includes(code)) return "霧雨";
    if ([61,63,65,66,67].includes(code)) return "雨";
    if ([71,73,75,77].includes(code)) return "雪";
    if ([80,81,82].includes(code)) return "にわか雨";
    if ([95,96,99].includes(code)) return "雷雨";
    return "不明";
  }

  function weatherCategory(code) {
    if (code === 0 || [1,2].includes(code)) return "clear";
    if ([61,63,65,66,67,80,81,82,51,53,55,56,57,95,96,99].includes(code)) return "rain";
    return "other";
  }

  async function fetchWeatherByCoords(lat, lon) {
    const url = new URL(OPEN_METEO_URL);
    url.searchParams.set("latitude", lat);
    url.searchParams.set("longitude", lon);
    url.searchParams.set("current", "weather_code,wind_speed_10m");
    url.searchParams.set("timezone", "auto");

    const res = await fetch(url.toString());
    if (!res.ok) throw new Error("天気取得に失敗しました");
    const data = await res.json();

    const code = data?.current?.weather_code;
    const wind = data?.current?.wind_speed_10m;
    if (typeof code !== "number" || typeof wind !== "number") {
      throw new Error("天気データの形式が想定と違います");
    }
    return { code, wind };
  }

  function getCurrentPosition() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) return reject(new Error("このブラウザは位置情報に対応していません"));
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: false,
        timeout: 8000,
        maximumAge: 60_000,
      });
    });
  }

  // ---------------------------
  // 2) Tone.js: synth + musical logic
  // ---------------------------
  let isRunning = false;
  let synth, reverb, filter, loop;
  let lastWeather = { code: 0, wind: 0 };

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

  // 風速(m/s) -> 発音間隔(s)
  function windToIntervalSeconds(wind) {
    const w = clamp(wind, 0, 15);
    const t = 1.2 - (w / 15) * 1.02;
    return clamp(t, 0.18, 1.2);
  }

  function pickScale(category) {
    if (category === "clear") return ["C4","D4","E4","G4","A4","C5"];
    if (category === "rain")  return ["A2","C3","D3","E3","G3","A3"];
    return ["D3","E3","F3","A3","B3","D4"];
  }

  function applyBackground(category) {
    document.body.classList.remove(
      "bg-gradient-to-b","from-orange-50","to-orange-200",
      "from-indigo-950","to-slate-900",
      "from-slate-100","to-slate-300"
    );
    document.body.classList.add("bg-gradient-to-b");
    if (category === "clear") {
      document.body.classList.add("from-orange-50","to-orange-200");
    } else if (category === "rain") {
      document.body.classList.add("from-indigo-950","to-slate-900");
    } else {
      document.body.classList.add("from-slate-100","to-slate-300");
    }
  }

  function setStatus(msg) {
    document.getElementById("status").textContent = msg;
  }

  function updateUI({ code, wind }) {
    const cat = weatherCategory(code);
    document.getElementById("weatherText").textContent = describeWeather(code);
    document.getElementById("weatherCode").textContent = String(code);
    document.getElementById("windSpeed").textContent = wind.toFixed(1);

    const interval = windToIntervalSeconds(wind);
    const density = (1 / interval).toFixed(1) + " notes/sec";
    document.getElementById("density").textContent = density;

    applyBackground(cat);
  }

  function ensureAudioGraph() {
    if (synth) return;

    reverb = new Tone.Reverb({ decay: 4.5, wet: 0.25 }).toDestination();
    filter = new Tone.Filter({ type: "lowpass", frequency: 1200, rolloff: -12 }).connect(reverb);

    synth = new Tone.PolySynth(Tone.Synth, {
      oscillator: { type: "sine" },
      envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 1.0 }
    }).connect(filter);
  }

  function rebuildLoop() {
    if (loop) {
      loop.dispose();
      loop = null;
    }

    const { code, wind } = lastWeather;
    const cat = weatherCategory(code);
    const scale = pickScale(cat);

    if (filter && reverb) {
      if (cat === "rain") {
        filter.frequency.value = 700;
        reverb.wet.value = 0.35;
      } else if (cat === "clear") {
        filter.frequency.value = 1600;
        reverb.wet.value = 0.22;
      } else {
        filter.frequency.value = 1100;
        reverb.wet.value = 0.28;
      }
    }

    const interval = windToIntervalSeconds(wind);

    loop = new Tone.Loop((time) => {
      const note = scale[Math.floor(Math.random() * scale.length)];
      const chordChance = (cat === "clear") ? 0.22 : (cat === "rain" ? 0.12 : 0.16);

      if (Math.random() < chordChance) {
        const n2 = scale[Math.floor(Math.random() * scale.length)];
        synth.triggerAttackRelease([note, n2], 0.08, time, 0.35);
      } else {
        synth.triggerAttackRelease(note, 0.08, time, 0.35);
      }
    }, interval).start(0);
  }

  async function start() {
    ensureAudioGraph();
    await Tone.start(); // iOS: ユーザー操作から呼ぶ必要あり
    Tone.Transport.bpm.value = 80;
    Tone.Transport.start();
    rebuildLoop();

    isRunning = true;
    document.getElementById("btnToggle").textContent = "Stop";
    document.getElementById("btnToggle").classList.remove("bg-emerald-600","hover:bg-emerald-500");
    document.getElementById("btnToggle").classList.add("bg-rose-600","hover:bg-rose-500");
    setStatus("再生中（風に同期して変化）");
  }

  function stop() {
    isRunning = false;
    if (loop) { loop.stop(); loop.dispose(); loop = null; }
    Tone.Transport.stop();
    document.getElementById("btnToggle").textContent = "Start";
    document.getElementById("btnToggle").classList.remove("bg-rose-600","hover:bg-rose-500");
    document.getElementById("btnToggle").classList.add("bg-emerald-600","hover:bg-emerald-500");
    setStatus("停止中（Startで再開）");
  }

  async function refreshWeather(auto = true) {
    try {
      setStatus("天気取得中…");
      let lat, lon;

      if (auto) {
        const pos = await getCurrentPosition();
        lat = pos.coords.latitude;
        lon = pos.coords.longitude;
      } else {
        lat = parseFloat(document.getElementById("lat").value);
        lon = parseFloat(document.getElementById("lon").value);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error("lat/lon を数値で入力してね");
      }

      const { code, wind } = await fetchWeatherByCoords(lat, lon);
      lastWeather = { code, wind };
      updateUI(lastWeather);

      if (isRunning) {
        rebuildLoop();
        setStatus("再生中（天気/風を反映して更新）");
      } else {
        setStatus("取得OK（Startで音が鳴る）");
      }
    } catch (e) {
      console.error(e);
      setStatus(`エラー: ${e.message}`);
    }
  }

  // UI events
  document.getElementById("btnToggle").addEventListener("click", async () => {
    if (!isRunning) await start();
    else stop();
  });

  document.getElementById("btnRefresh").addEventListener("click", () => refreshWeather(true));
  document.getElementById("btnUseManual").addEventListener("click", () => refreshWeather(false));

  applyBackground("other");
  refreshWeather(true);
</script>
</body>
</html>
