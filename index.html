function rebuildLoops(){
  disposeLoops();
  const r = applyParams();

  // ====== ランダム・ハーモナイズ（I/IV/V のメジャートライアドのみ） ======
  // Keyごとの安全な候補（根音だけランダムに選ぶ）
  const triadChoicesByKey = {
    "C":  ["C4","F4","G4"],
    "D":  ["D4","G4","A4"],
    "Eb": ["Eb4","Ab4","Bb4"],
    "A":  ["A3","D4","E4"]
  };
  const choices = triadChoicesByKey[r.key] || triadChoicesByKey["C"];

  const triadInterval = clamp(windToIntervalSeconds(lastWeather.wind) * 2.0, 0.9, 3.2);

  let lastRoot = null;
  triadLoop = new Tone.Loop((time) => {
    // 直前と同じ和音が続かないようにする
    let root = choices[Math.floor(Math.random() * choices.length)];
    if (root === lastRoot) {
      root = choices[Math.floor(Math.random() * choices.length)];
    }
    lastRoot = root;

    pad.triggerAttackRelease(triad(root), 0.60, time, 0.70);
  }, triadInterval).start(0);

  // ====== きらめき：単音 + Delay（環境で少し変化） ======
  const sparkleInterval = clamp(windToIntervalSeconds(lastWeather.wind) * 0.95, 0.22, 0.95);
  const scale = sparkleScale(r.key, r.weatherCat, r.time);

  // Delayの雰囲気を環境で調整（やりすぎない）
  if (sparkleDelay){
    // 夜は少し長め、雨は少しウェット多め
    const night = (r.time === "night" || r.time === "late");
    const rain = (r.weatherCat === "rain");

    sparkleDelay.delayTime.value = night ? Tone.Time("8n").toSeconds() : Tone.Time("16n").toSeconds();
    sparkleDelay.feedback.value  = rain ? 0.26 : 0.20;
    sparkleDelay.wet.value       = night ? 0.22 : (rain ? 0.20 : 0.16);
  }

  sparkleLoop = new Tone.Loop((time) => {
    let p = 0.75;
    if (r.weatherCat === "rain") p = 0.58;
    if (r.time === "late") p = 0.45;
    if (r.time === "night") p = Math.min(p, 0.55);
    if (r.weatherCat === "clear" && (r.time === "day" || r.time === "morning")) p = 0.85;

    if (Math.random() < p){
      const note = scale[Math.floor(Math.random() * scale.length)];

      if (Math.random() < 0.16){
        const note2 = scale[Math.floor(Math.random() * scale.length)];
        const dur = 0.09;
        sparkle.triggerAttackRelease(note, dur, time, 0.45);
        sparkle.triggerAttackRelease(note2, dur, time + 0.001, 0.35);
      } else {
        sparkle.triggerAttackRelease(note, 0.09, time, 0.45);
      }
    }
  }, sparkleInterval).start(0);
}
